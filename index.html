<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URL_Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        /* 全域字體設定：嚴格使用無襯線體 */
        body {
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f7f3e9; 
            background-image: radial-gradient(#e0d7c1 1px, transparent 1px);
            background-size: 24px 24px;
            color: #4a3f35;
        }

        /* 吉卜立風柔和陰影 */
        .ghibli-shadow {
            box-shadow: 0 4px 10px -2px rgba(74, 63, 53, 0.08);
            border: 2px solid #d1c7b7;
        }

        .ghibli-input {
            background-color: rgba(255, 255, 255, 0.9);
            border: 2px solid #d1c7b7;
            transition: all 0.3s;
        }
        .ghibli-input:focus {
            outline: none;
            border-color: #8fb4a2;
            background-color: #fff;
            box-shadow: 0 0 0 3px rgba(143, 180, 162, 0.15);
        }

        /* 拖曳預留位置 */
        .sortable-ghost {
            opacity: 0.4;
            background-color: #8fb4a2 !important;
            border: 2px dashed #4a3f35 !important;
        }

        /* 分類標籤：白底、彩色邊框與文字 */
        .filter-chip {
            transition: all 0.2s;
            white-space: nowrap;
            flex-shrink: 0;
            font-size: 0.85rem; 
            background-color: #ffffff;
            border-width: 1.5px;
            border-style: solid;
        }
        
        /* 選中狀態：滿色背景 */
        .filter-chip.active {
            color: white !important;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        /* 網址明細內的小標籤格式 */
        .item-tag {
            background-color: #ffffff;
            border-width: 1px;
            border-style: solid;
            padding: 1px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 6px;
            display: inline-block;
        }

        .tab-btn {
            background-color: #e8e2d5;
            color: #6b5e51;
            border: 2px solid #d1c7b7;
            border-bottom: none;
            font-size: 0.8rem;
        }
        .tab-btn.active {
            background-color: #fff;
            color: #4a3f35;
            border-color: #d1c7b7;
            font-weight: bold;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .loading-spinner {
            border: 4px solid #e8e2d5;
            border-top: 4px solid #8fb4a2;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1.5s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .hidden-handle {
            width: 10px;
            cursor: grab;
        }
    </style>
</head>
<body class="pb-20 min-h-screen flex flex-col items-center">

    <div class="w-full max-w-lg px-4 mt-8">
        <div class="text-center mb-4 border-b-2 border-[#d1c7b7] pb-1">
            <h1 class="text-3xl font-black text-[#4a3f35] tracking-tight uppercase">
                <i class="fa-solid fa-link text-[#8fb4a2] mr-1"></i>URL_MANAGER
            </h1>
        </div>

        <div class="mb-6">
            <div class="flex gap-1">
                <button onclick="switchTab('link')" id="tab-link" class="tab-btn active px-5 py-2 rounded-t-xl font-bold">
                    新增連結
                </button>
                <button onclick="switchTab('category')" id="tab-category" class="tab-btn px-5 py-2 rounded-t-xl font-bold">
                    新增分類
                </button>
            </div>

            <div class="bg-white p-4 border-2 border-[#d1c7b7] ghibli-shadow rounded-b-2xl rounded-tr-2xl">
                <div id="panel-link" class="flex flex-col gap-3">
                    <div class="flex gap-2">
                        <select id="newLinkCat" class="ghibli-input w-1/3 px-2 py-2.5 rounded-lg text-xs font-bold text-[#6b5e51]">
                            <option value="">未分類</option>
                        </select>
                        <input type="text" id="newDesc" placeholder="輸入標題" class="ghibli-input w-2/3 px-3 py-2.5 text-xs rounded-lg">
                    </div>
                    <input type="url" id="newUrl" placeholder="輸入網址 (https://...)" class="ghibli-input w-full px-3 py-2.5 text-xs rounded-lg">
                    <button onclick="addItem()" class="w-full bg-[#8fb4a2] text-white py-2.5 rounded-xl hover:bg-[#7da390] font-bold text-sm transition-colors">
                        新增連結 <i class="fa-solid fa-plus ml-1"></i>
                    </button>
                </div>

                <div id="panel-category" class="hidden flex flex-col gap-3">
                    <input type="text" id="newCatName" placeholder="輸入新分類名稱" class="ghibli-input w-full px-3 py-2.5 text-xs rounded-lg">
                    <button onclick="addCategory()" class="w-full bg-[#5c8a97] text-white py-2.5 rounded-xl hover:bg-[#4d7885] font-bold text-sm transition-colors">
                        建立分類 <i class="fa-solid fa-folder ml-1"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="mb-4">
            <div class="flex overflow-x-auto gap-3 no-scrollbar px-1 py-2 items-center" id="filter-bar"></div>
        </div>

        <div id="cat-toolbar" class="hidden mb-3 flex items-center justify-between border-b border-[#d1c7b7] pb-2 px-1">
            <div class="flex items-center gap-2">
                <span id="current-cat-badge" class="text-xs font-bold text-white px-3 py-1 rounded-lg">
                    <i class="fa-solid fa-folder-open mr-1"></i>
                    <span id="current-cat-name-display">分類名稱</span>
                </span>
                <button onclick="openCatEditModal()" class="text-[#b7ad9d] hover:text-[#5c8a97]">
                    <i class="fa-solid fa-gear text-xs"></i>
                </button>
            </div>
        </div>

        <div class="relative mb-4">
            <i class="fa-solid fa-search absolute left-4 top-2.5 text-[#b7ad9d] text-xs"></i>
            <input type="text" id="searchInput" placeholder="搜尋..." 
                class="ghibli-input w-full pl-10 pr-4 py-2 border-2 rounded-xl text-xs font-bold">
        </div>

        <div id="loading" class="loading-spinner mx-auto my-10"></div>
        <div id="main-container" class="space-y-3 hidden pb-10"></div>
        <p id="empty-msg" class="text-center text-[#b7ad9d] mt-10 hidden font-bold text-xs">[ 無資料 ]</p>
    </div>

    <div id="editModal" class="fixed inset-0 bg-[#4a3f35]/50 hidden flex items-center justify-center z-50 px-4 backdrop-blur-sm">
        <div class="bg-white p-6 w-full max-w-sm ghibli-shadow rounded-2xl relative">
            <button onclick="closeEditModal()" class="absolute top-3 right-4 text-[#b7ad9d] hover:text-[#4a3f35] text-lg">
                <i class="fa-solid fa-times"></i>
            </button>
            <h3 class="text-sm font-bold text-[#4a3f35] mb-4 flex items-center gap-2 border-b pb-2">
                <i class="fa-solid fa-pen-to-square"></i> 編輯連結
            </h3>
            <input type="hidden" id="editKey">
            <div class="space-y-3">
                <div>
                    <label class="block text-[#a89d8d] text-[10px] font-bold mb-1 ml-1">所屬分類</label>
                    <select id="editCatId" class="ghibli-input w-full px-3 py-2.5 rounded-lg text-xs font-bold"></select>
                </div>
                <div>
                    <label class="block text-[#a89d8d] text-[10px] font-bold mb-1 ml-1">標題描述</label>
                    <input type="text" id="editDesc" class="ghibli-input w-full px-3 py-2.5 rounded-lg text-xs">
                </div>
                <div>
                    <label class="block text-[#a89d8d] text-[10px] font-bold mb-1 ml-1">網址 URL</label>
                    <input type="text" id="editUrl" class="ghibli-input w-full px-3 py-2.5 rounded-lg text-[10px] font-mono">
                </div>
            </div>
            <div class="flex justify-between items-center mt-6 gap-3">
                <button onclick="deleteCurrentItem()" class="px-4 py-2 text-red-400 font-bold text-xs hover:bg-red-50 rounded-lg">刪除</button>
                <button onclick="saveEdit()" class="px-7 py-2.5 bg-[#8fb4a2] text-white font-bold rounded-xl text-xs">儲存更新</button>
            </div>
        </div>
    </div>

    <div id="catEditModal" class="fixed inset-0 bg-[#4a3f35]/50 hidden flex items-center justify-center z-50 px-4 backdrop-blur-sm">
        <div class="bg-white p-6 w-full max-w-sm ghibli-shadow rounded-2xl relative">
            <button onclick="closeCatModal()" class="absolute top-3 right-4 text-[#b7ad9d] hover:text-[#4a3f35] text-lg">
                <i class="fa-solid fa-times"></i>
            </button>
            <h3 class="text-sm font-bold text-[#4a3f35] mb-4 flex items-center gap-2 border-b pb-2">
                <i class="fa-solid fa-folder"></i> 編輯分類
            </h3>
            <input type="hidden" id="editCatKey">
            <input type="text" id="editCatNameInput" class="ghibli-input w-full px-3 py-2.5 rounded-lg text-xs font-bold">
            <div class="flex justify-between items-center mt-6 gap-3">
                <button onclick="deleteCurrentCategory()" class="px-4 py-2 text-red-400 font-bold text-xs hover:bg-red-50 rounded-lg">刪除分類</button>
                <button onclick="saveCatEdit()" class="px-7 py-2.5 bg-[#5c8a97] text-white font-bold rounded-xl text-xs">儲存</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, push, set, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDlxwcj-PSv2Bc1UFgjlVnKUmIzvwXmBig",
            authDomain: "url-sorting.firebaseapp.com",
            projectId: "url-sorting",
            storageBucket: "url-sorting.firebasestorage.app",
            messagingSenderId: "576779796443",
            appId: "1:576779796443:web:6f3026b1cc926619e0f1fe",
            databaseURL: "https://url-sorting-default-rtdb.firebaseio.com"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        let state = { links: [], categories: [], currentFilter: 'all' };
        let linkSortables = [];
        let catSortable = null;

        const ghibliColors = ["#8fb4a2", "#5c8a97", "#d6a278", "#e3b04b", "#9b8b7a", "#a8c69f", "#7892a0", "#c8a49a"];

        function getCatColor(id) {
            if (id === 'all') return "#4a3f35";
            if (id === 'uncategorized') return "#9b8b7a";
            let hash = 0;
            for (let i = 0; i < id.length; i++) hash = id.charCodeAt(i) + ((hash << 5) - hash);
            return ghibliColors[Math.abs(hash) % ghibliColors.length];
        }

        function appendExternalBrowserParam(url) {
            if (!url) return url;
            const param = "openExternalBrowser=1";
            if (url.includes(param)) return url;
            const separator = url.includes('?') ? '&' : '?';
            return `${url}${separator}${param}`;
        }

        function initDataListeners() {
            onValue(ref(db, 'links'), (snapshot) => {
                const data = snapshot.val();
                state.links = data ? Object.keys(data).map(key => ({ id: key, ...data[key] })) : [];
                state.links.sort((a, b) => (a.order || 0) - (b.order || 0));
                renderFilterBar();
                checkAndRender();
            });

            onValue(ref(db, 'categories'), (snapshot) => {
                const data = snapshot.val();
                state.categories = data ? Object.keys(data).map(key => ({ id: key, ...data[key] })) : [];
                state.categories.sort((a, b) => (a.order || 0) - (b.order || 0));
                updateCategoryDropdowns();
                renderFilterBar();
                checkAndRender();
            });
        }

        function renderFilterBar() {
            const bar = document.getElementById('filter-bar');
            bar.innerHTML = '';
            if(catSortable) { catSortable.destroy(); catSortable = null; }
            bar.appendChild(createFilterChip('全部', 'all'));
            state.categories.forEach(cat => {
                const catBtn = createFilterChip(cat.name, cat.id);
                catBtn.dataset.catId = cat.id;
                bar.appendChild(catBtn);
            });
            const hasUncategorized = state.links.some(l => !l.categoryId || !state.categories.find(c => c.id === l.categoryId));
            if (hasUncategorized) bar.appendChild(createFilterChip('未分類', 'uncategorized'));
            catSortable = Sortable.create(bar, {
                animation: 200,
                filter: '.static-chip',
                onEnd: function () {
                    const updates = {};
                    let orderIndex = 0;
                    Array.from(bar.children).forEach((item) => {
                        if (item.dataset.catId) updates[`categories/${item.dataset.catId}/order`] = orderIndex++;
                    });
                    if(Object.keys(updates).length > 0) update(ref(db), updates);
                }
            });
        }

        function createFilterChip(text, filterId) {
            const btn = document.createElement('button');
            const isActive = state.currentFilter === filterId;
            const color = getCatColor(filterId);
            btn.className = `filter-chip px-5 py-2 rounded-full font-bold transition-all duration-200 ${isActive ? 'active' : ''}`;
            btn.textContent = text;
            if (isActive) {
                btn.style.backgroundColor = color;
                btn.style.borderColor = color;
            } else {
                btn.style.color = color;
                btn.style.borderColor = color;
            }
            if (filterId === 'all' || filterId === 'uncategorized') btn.classList.add('static-chip');
            btn.onclick = () => {
                state.currentFilter = filterId;
                renderFilterBar();
                checkAndRender();
                document.getElementById('newLinkCat').value = (filterId === 'all' || filterId === 'uncategorized') ? "" : filterId;
            };
            return btn;
        }

        function checkAndRender() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('main-container').classList.remove('hidden');
            const catToolbar = document.getElementById('cat-toolbar');
            if (state.currentFilter !== 'all' && state.currentFilter !== 'uncategorized') {
                const currentCat = state.categories.find(c => c.id === state.currentFilter);
                if (currentCat) {
                    catToolbar.classList.remove('hidden');
                    document.getElementById('current-cat-name-display').textContent = currentCat.name;
                    document.getElementById('current-cat-badge').style.backgroundColor = getCatColor(state.currentFilter);
                } else catToolbar.classList.add('hidden');
            } else catToolbar.classList.add('hidden');
            renderMain(document.getElementById('searchInput').value);
        }

        function renderMain(filterText = '') {
            const container = document.getElementById('main-container');
            container.innerHTML = '';
            linkSortables.forEach(s => s.destroy());
            linkSortables = [];
            const term = filterText.toLowerCase();
            let hasData = false;
            const renderBlock = (cat, links, isUncat) => {
                if (links.length > 0) {
                    renderCategoryBlock(container, cat, links, term.length > 0, isUncat);
                    hasData = true;
                }
            };
            if (state.currentFilter === 'all') {
                state.categories.forEach(cat => renderBlock(cat, state.links.filter(l => l.categoryId === cat.id && matchFilter(l, term)), false));
                renderBlock({ id: 'uncategorized', name: '未分類' }, state.links.filter(l => (!l.categoryId || !state.categories.find(c => c.id === l.categoryId)) && matchFilter(l, term)), true);
            } else if (state.currentFilter === 'uncategorized') {
                renderBlock({ id: 'uncategorized', name: '未分類' }, state.links.filter(l => (!l.categoryId || !state.categories.find(c => c.id === l.categoryId)) && matchFilter(l, term)), true);
            } else {
                const cat = state.categories.find(c => c.id === state.currentFilter);
                if (cat) renderBlock(cat, state.links.filter(l => l.categoryId === cat.id && matchFilter(l, term)), false);
            }
            document.getElementById('empty-msg').classList.toggle('hidden', hasData);
        }

        function matchFilter(item, term) { return !term || (item.desc && item.desc.toLowerCase().includes(term)) || (item.url && item.url.toLowerCase().includes(term)); }

        function renderCategoryBlock(container, cat, links, isSearching, isUncat) {
            const ul = document.createElement('ul');
            ul.className = 'space-y-2.5 min-h-[10px]';
            ul.dataset.catId = cat.id;
            links.forEach(link => {
                const finalUrl = appendExternalBrowserParam(link.url);
                const li = document.createElement('li');
                li.className = `bg-white p-3 ghibli-shadow rounded-xl flex items-center gap-2 group transition-all hover:bg-[#faf9f6]`;
                li.dataset.id = link.id;
                const catColor = getCatColor(cat.id);
                
                // 網址明細標籤：改為白底彩色線條字體
                let tag = (state.currentFilter === 'all' && !isUncat) ? 
                    `<span class="item-tag" style="color: ${catColor}; border-color: ${catColor}">${escapeHtml(cat.name)}</span>` : '';
                
                li.innerHTML = `
                    <div class="hidden-handle flex-shrink-0"></div>
                    <div class="flex-grow min-w-0">
                        <div class="flex items-center"><span class="font-bold text-[#4a3f35] truncate text-sm">${escapeHtml(link.desc)}</span>${tag}</div>
                        <div class="text-[10px] text-[#5c8a97] truncate mt-0.5 font-mono"><a href="${finalUrl}" target="_blank">${escapeHtml(finalUrl)}</a></div>
                    </div>
                    <div class="flex gap-1.5">
                        <button onclick="copyToClipboard(this, '${escapeHtml(link.desc)}', '${escapeHtml(finalUrl)}')" class="w-7 h-7 flex items-center justify-center text-[#b7ad9d] hover:text-[#8fb4a2] transition-colors"><i class="fa-regular fa-copy text-xs"></i></button>
                        <button onclick="openEditModal('${link.id}', '${escapeHtml(link.desc)}', '${escapeHtml(link.url)}', '${link.categoryId || ''}')" class="w-7 h-7 flex items-center justify-center text-[#b7ad9d] hover:text-[#5c8a97] transition-colors"><i class="fa-solid fa-pen text-xs"></i></button>
                    </div>
                `;
                ul.appendChild(li);
            });
            container.appendChild(ul);
            if (!isSearching) {
                linkSortables.push(Sortable.create(ul, {
                    group: 'shared-links', handle: 'li', animation: 200, ghostClass: 'sortable-ghost',
                    onEnd: (evt) => {
                        const updates = {};
                        const newCatId = evt.to.dataset.catId;
                        updates[`links/${evt.item.dataset.id}/categoryId`] = newCatId === 'uncategorized' ? null : newCatId;
                        Array.from(evt.to.children).forEach((child, idx) => { if (child.dataset.id) updates[`links/${child.dataset.id}/order`] = idx; });
                        update(ref(db), updates);
                    }
                }));
            }
        }

        function updateCategoryDropdowns() {
            let opts = '<option value="">未分類</option>';
            state.categories.forEach(cat => opts += `<option value="${cat.id}">${escapeHtml(cat.name)}</option>`);
            document.getElementById('newLinkCat').innerHTML = document.getElementById('editCatId').innerHTML = opts;
        }

        window.addItem = function() {
            const desc = document.getElementById('newDesc').value.trim();
            let url = document.getElementById('newUrl').value.trim();
            const catId = document.getElementById('newLinkCat').value;
            if (!desc || !url) return;
            if (!url.startsWith('http')) url = 'https://' + url;
            const newRef = push(ref(db, 'links'));
            set(newRef, { desc, url: appendExternalBrowserParam(url), categoryId: catId || null, order: 999, timestamp: Date.now() })
            .then(() => { document.getElementById('newDesc').value = document.getElementById('newUrl').value = ''; });
        };

        window.addCategory = function() {
            const name = document.getElementById('newCatName').value.trim();
            if(!name) return;
            const newRef = push(ref(db, 'categories'));
            set(newRef, { name, order: state.categories.length }).then(() => { document.getElementById('newCatName').value = ''; switchTab('link'); });
        };

        window.deleteCurrentItem = () => confirm('確定要刪除嗎？') && remove(ref(db, 'links/' + document.getElementById('editKey').value)).then(closeEditModal);
        window.saveEdit = () => {
            const key = document.getElementById('editKey').value;
            update(ref(db, 'links/' + key), { 
                desc: document.getElementById('editDesc').value.trim(), 
                url: appendExternalBrowserParam(document.getElementById('editUrl').value.trim()), 
                categoryId: document.getElementById('editCatId').value || null 
            }).then(closeEditModal);
        };

        window.openCatEditModal = () => {
            const cat = state.categories.find(c => c.id === state.currentFilter);
            if (!cat) return;
            document.getElementById('editCatKey').value = cat.id;
            document.getElementById('editCatNameInput').value = cat.name;
            document.getElementById('catEditModal').classList.remove('hidden');
        };

        window.deleteCurrentCategory = () => {
            if (confirm('確定刪除分類？連結將變為未分類。')) {
                const updates = {};
                state.links.filter(l => l.categoryId === document.getElementById('editCatKey').value).forEach(l => updates[`links/${l.id}/categoryId`] = null);
                updates[`categories/${document.getElementById('editCatKey').value}`] = null;
                update(ref(db), updates).then(() => { closeCatModal(); state.currentFilter = 'all'; });
            }
        };

        window.saveCatEdit = () => update(ref(db, 'categories/' + document.getElementById('editCatKey').value), { name: document.getElementById('editCatNameInput').value.trim() }).then(closeCatModal);
        window.switchTab = (tab) => {
            document.getElementById('panel-link').classList.toggle('hidden', tab !== 'link');
            document.getElementById('panel-category').classList.toggle('hidden', tab !== 'category');
            document.getElementById('tab-link').classList.toggle('active', tab === 'link');
            document.getElementById('tab-category').classList.toggle('active', tab === 'category');
        };

        window.openEditModal = (key, desc, url, catId) => {
            document.getElementById('editKey').value = key;
            document.getElementById('editDesc').value = desc;
            document.getElementById('editUrl').value = url;
            document.getElementById('editCatId').value = catId || "";
            document.getElementById('editModal').classList.remove('hidden');
        };

        window.closeEditModal = () => document.getElementById('editModal').classList.add('hidden');
        window.closeCatModal = () => document.getElementById('catEditModal').classList.add('hidden');
        window.copyToClipboard = (btn, desc, url) => navigator.clipboard.writeText(`${desc} - ${url}`).then(() => {
            const icon = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-check text-[#8fb4a2]"></i>';
            setTimeout(() => btn.innerHTML = icon, 1000);
        });

        document.getElementById('searchInput').addEventListener('input', (e) => renderMain(e.target.value));
        function escapeHtml(t) { return t ? t.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#039;"}[m])) : t; }
        initDataListeners();
    </script>
</body>
</html>